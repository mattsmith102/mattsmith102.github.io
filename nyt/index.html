<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NYT Puzzles — Today</title>

  <!-- Bootstrap 5 (CDN). If you want local files later, shout. -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    pre { white-space: pre-wrap; word-break: break-word; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small-muted { font-size: .9rem; color: #6c757d; }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <div>
        <h1 class="h3 mb-1">NYT Puzzles — Today</h1>
        <div class="small-muted">Loads puzzle JSON via your Worker and shows “today’s” solutions.</div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0" for="date">Date</label>
        <input id="date" type="date" class="form-control" style="width: 170px;">
        <button id="refresh" class="btn btn-primary">Refresh</button>
      </div>
    </div>

    <div id="alerts"></div>

    <div class="accordion" id="puzzleAccordion"></div>

    <div class="mt-4 small-muted">
      Tip: If something fails, expand it — you’ll see the error + the raw JSON (when available).
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Your Worker base
    const WORKER_BASE = "https://nyt-proxy.hello-337.workers.dev";

    // Helper: ISO date YYYY-MM-DD
    const todayISO = () => new Date().toISOString().slice(0, 10);

    // ---- Puzzle configs ----
    // Each puzzle entry:
    // - name: shown in UI
    // - buildUrl(date): returns a FULL Worker URL
    // - extract(data): returns HTML string for "solution" area
    //
    // Add your other puzzle APIs here once you paste the URLs.
    const PUZZLES = [
      {
        id: "wordle",
        name: "Wordle",
        buildUrl: (date) => `${WORKER_BASE}/nyt/wordle/v2/${date}.json`,
        extract: (data) => {
          // Common fields in that JSON: solution, days_since_launch, etc.
          // We'll be defensive.
          const solution = data?.solution ?? "(no solution field found)";
          const number = data?.days_since_launch ?? data?.day ?? data?.id ?? "";
          const par = data?.par ?? "";
          return `
            <div class="mb-2"><strong>Solution:</strong> <span class="mono">${escapeHtml(solution)}</span></div>
            ${number !== "" ? `<div class="mb-2"><strong>Number:</strong> <span class="mono">${escapeHtml(String(number))}</span></div>` : ``}
            ${par !== "" ? `<div class="mb-2"><strong>Par:</strong> <span class="mono">${escapeHtml(String(par))}</span></div>` : ``}
          `;
        }
      },

      // Example placeholders (replace with real ones when you provide URLs)
      // {
      //   id: "connections",
      //   name: "Connections",
      //   buildUrl: (date) => `${WORKER_BASE}/nyt/???/${date}.json`,
      //   extract: (data) => `<div><strong>Answer:</strong> ...</div>`
      // },
    ];

    // ---- UI rendering ----
    function renderAccordion() {
      const acc = document.getElementById("puzzleAccordion");
      acc.innerHTML = "";

      for (const p of PUZZLES) {
        const itemId = `acc-${p.id}`;
        const headingId = `heading-${p.id}`;
        const collapseId = `collapse-${p.id}`;

        acc.insertAdjacentHTML("beforeend", `
          <div class="accordion-item shadow-sm mb-2">
            <h2 class="accordion-header" id="${headingId}">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#${collapseId}"
                      aria-expanded="false" aria-controls="${collapseId}">
                <span class="fw-semibold">${escapeHtml(p.name)}</span>
                <span class="ms-auto small-muted" id="${itemId}-status">Idle</span>
              </button>
            </h2>

            <div id="${collapseId}" class="accordion-collapse collapse"
                 aria-labelledby="${headingId}" data-bs-parent="#puzzleAccordion">
              <div class="accordion-body">
                <div class="mb-3" id="${itemId}-solution">
                  <div class="text-muted">Not loaded yet.</div>
                </div>

                <details>
                  <summary class="small-muted">Raw JSON</summary>
                  <pre class="border rounded p-2 bg-white mt-2 mono" id="${itemId}-raw">{}</pre>
                </details>

                <div class="small-muted mt-2">
                  Source: <a href="#" id="${itemId}-link" target="_blank" rel="noopener noreferrer">open request URL</a>
                </div>
              </div>
            </div>
          </div>
        `);
      }
    }

    function setStatus(puzzleId, text) {
      const el = document.getElementById(`acc-${puzzleId}-status`);
      if (el) el.textContent = text;
    }

    function setSolution(puzzleId, html) {
      const el = document.getElementById(`acc-${puzzleId}-solution`);
      if (el) el.innerHTML = html;
    }

    function setRaw(puzzleId, objOrText) {
      const el = document.getElementById(`acc-${puzzleId}-raw`);
      if (!el) return;
      el.textContent = typeof objOrText === "string" ? objOrText : JSON.stringify(objOrText, null, 2);
    }

    function setLink(puzzleId, url) {
      const el = document.getElementById(`acc-${puzzleId}-link`);
      if (el) el.href = url;
    }

    function showAlert(message, type = "warning") {
      const alerts = document.getElementById("alerts");
      alerts.insertAdjacentHTML("beforeend", `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${escapeHtml(message)}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `);
    }

    // ---- Fetching ----
    async function loadAll(date) {
      // Clear old alerts
      document.getElementById("alerts").innerHTML = "";

      await Promise.allSettled(PUZZLES.map(p => loadOne(p, date)));
    }

    async function loadOne(p, date) {
      const url = p.buildUrl(date);
      setLink(p.id, url);

      setStatus(p.id, "Loading…");
      setSolution(p.id, `<div class="text-muted">Fetching…</div>`);
      setRaw(p.id, "{}");

      try {
        const r = await fetch(url, { cache: "no-store" });
        const text = await r.text(); // read as text first so we can show raw even on JSON parse issues

        if (!r.ok) {
          setStatus(p.id, `HTTP ${r.status}`);
          setSolution(p.id, `<div class="text-danger">Request failed: HTTP ${r.status}</div>`);
          setRaw(p.id, text);
          return;
        }

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          setStatus(p.id, "Bad JSON");
          setSolution(p.id, `<div class="text-danger">Could not parse JSON.</div>`);
          setRaw(p.id, text);
          return;
        }

        setRaw(p.id, data);

        const solutionHtml = p.extract(data);
        setSolution(p.id, solutionHtml);

        setStatus(p.id, "OK");
      } catch (e) {
        setStatus(p.id, "Error");
        setSolution(p.id, `<div class="text-danger">Error: ${escapeHtml(e.message)}</div>`);
        setRaw(p.id, String(e));
      }
    }

    // ---- Utils ----
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[c]));
    }

    // ---- Init ----
    renderAccordion();

    const dateEl = document.getElementById("date");
    dateEl.value = todayISO();

    document.getElementById("refresh").addEventListener("click", () => {
      loadAll(dateEl.value);
    });

    // Auto-load on first view
    loadAll(dateEl.value);
  </script>
</body>
</html>
