<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NYT Puzzles — Today</title>

  <!-- Bootstrap 5 (CDN). If you want local files later, say the word. -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    pre { white-space: pre-wrap; word-break: break-word; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small-muted { font-size: .9rem; color: #6c757d; }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <div>
        <h1 class="h3 mb-1">NYT Games Solutions</h1>
      </div>

      <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0" for="date">Date</label>
        <input id="date" type="date" class="form-control">
        <button id="refresh" class="btn btn-primary">Refresh</button>

        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Quick dates
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><button class="dropdown-item" id="quickToday">Today</button></li>
            <li><button class="dropdown-item" id="quickYesterday">Yesterday</button></li>
            <li><button class="dropdown-item" id="quickTomorrow">Tomorrow</button></li>
          </ul>
        </div>
      </div>
    </div>

    <div id="alerts"></div>

    <div class="accordion" id="puzzleAccordion"></div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Your Worker base
    const WORKER_BASE = "https://nyt-proxy.hello-337.workers.dev";

    // ---- Helpers ----
    const isoDate = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
    const todayISO = () => isoDate(new Date());
    const addDaysISO = (days) => {
      const d = new Date();
      d.setDate(d.getDate() + days);
      return isoDate(d);
    };

    // ---- Puzzle configs ----
    // Each puzzle entry:
    // - id: unique
    // - name: UI label
    // - buildUrl(date): returns a FULL Worker URL
    // - extract(data): returns a plain text string (we render it in <pre>)
    // - renderExtras (optional): returns HTML string for extra UI (e.g. spelling bee answers)
    const PUZZLES = [
      {
        id: "wordle",
        name: "Wordle",
        buildUrl: (date) => `${WORKER_BASE}/nyt/wordle/v2/${date}.json`,
        extract: (data) => data?.solution ?? "(no solution)",
      },
      {
        id: "connections",
        name: "Connections",
        buildUrl: (date) => `${WORKER_BASE}/nyt/connections/v2/${date}.json`,
        extract: (data) => {
          const cats = Array.isArray(data?.categories) ? data.categories : [];
          if (!cats.length) return "(no categories)";

          // TITLE: word, word, word, word
          return cats.map((c, idx) => {
            const title = c?.title ?? `Group ${idx + 1}`;
            const cards = Array.isArray(c?.cards) ? c.cards : [];
            const words = cards.map(card => card?.content).filter(Boolean);
            return `${title}: ${words.join(", ") || "(no cards)"}`;
          }).join("\n");
        },
      },
      {
        id: "strands",
        name: "Strands",
        buildUrl: (date) => `${WORKER_BASE}/nyt/strands/v2/${date}.json`,
        extract: (data) => {
          const spangram = data?.spangram ?? "(no spangram)";
          const themeWords = Array.isArray(data?.themeWords) ? data.themeWords : [];
          return `Spangram: ${spangram}\nTheme words: ${themeWords.join(", ") || "(none)"}`;
        },
      },
      {
        id: "spelling-bee",
        name: "Spelling Bee",
        buildUrl: (date) => `${WORKER_BASE}/nyt/spelling-bee/v1/${date}.json`,
        extract: (data) => {
          const pangrams = Array.isArray(data?.pangrams) ? data.pangrams : [];
          const answers = Array.isArray(data?.answers) ? data.answers : [];
          const p = pangrams.length ? pangrams.join(", ") : "(no pangram)";
          return `Pangram${pangrams.length === 1 ? "" : "s"}: ${p}\nOther accepted words: ${answers.length}`;
        },
        renderExtras: (data, puzzleId) => {
          const answers = Array.isArray(data?.answers) ? data.answers : [];
          const safeList = escapeHtml(answers.join(", "));
          return `
            <details class="mt-3">
              <summary class="small-muted">Show accepted words</summary>
              <div class="border rounded p-2 bg-white mt-2 mono" style="white-space: pre-wrap;">
                ${answers.length ? safeList : "(none)"}
              </div>
            </details>
          `;
        }
      },
    ];

    // ---- UI rendering ----
    function renderAccordion() {
      const acc = document.getElementById("puzzleAccordion");
      acc.innerHTML = "";

      for (const p of PUZZLES) {
        const itemId = `acc-${p.id}`;
        const headingId = `heading-${p.id}`;
        const collapseId = `collapse-${p.id}`;

        acc.insertAdjacentHTML("beforeend", `
          <div class="accordion-item shadow-sm mb-2">
            <h2 class="accordion-header" id="${headingId}">
              <button class="accordion-button collapsed py-5" type="button"
                      data-bs-toggle="collapse" data-bs-target="#${collapseId}"
                      aria-expanded="false" aria-controls="${collapseId}">
                <span class="pe-3"><img src="https://www.nytimes.com/games-assets/v2/assets/icons/${escapeHtml(p.id)}.svg"/></span><span class="fw-semibold">${escapeHtml(p.name)}</span>
              </button>
            </h2>

            <div id="${collapseId}" class="accordion-collapse collapse"
                 aria-labelledby="${headingId}" data-bs-parent="#puzzleAccordion">
              <div class="accordion-body">

                <div class="mb-3" id="${itemId}-solution">
                  <div class="text-muted">Not loaded yet.</div>
                </div>

                <div id="${itemId}-extras"></div>
                
              </div>
            </div>
          </div>
        `);
      }
    }

    function setStatus(puzzleId, text) {
      const el = document.getElementById(`acc-${puzzleId}-status`);
      if (el) el.textContent = text;
    }

    function setSolution(puzzleId, text) {
      const el = document.getElementById(`acc-${puzzleId}-solution`);
      if (!el) return;
      el.innerHTML = `<pre class="mb-0 mono">${escapeHtml(text)}</pre>`;
    }

    function setExtras(puzzleId, html) {
      const el = document.getElementById(`acc-${puzzleId}-extras`);
      if (el) el.innerHTML = html || "";
    }

    function setRaw(puzzleId, objOrText) {
      const el = document.getElementById(`acc-${puzzleId}-raw`);
      if (!el) return;
      el.textContent = typeof objOrText === "string" ? objOrText : JSON.stringify(objOrText, null, 2);
    }

    function setLink(puzzleId, url) {
      const el = document.getElementById(`acc-${puzzleId}-link`);
      if (el) el.href = url;
    }

    function showAlert(message, type = "warning") {
      const alerts = document.getElementById("alerts");
      alerts.insertAdjacentHTML("beforeend", `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${escapeHtml(message)}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `);
    }

    // ---- Fetching ----
    async function loadAll(date) {
      document.getElementById("alerts").innerHTML = "";
      await Promise.allSettled(PUZZLES.map(p => loadOne(p, date)));
    }

    async function loadOne(p, date) {
      const url = p.buildUrl(date);
      setLink(p.id, url);

      setStatus(p.id, "Loading…");
      setSolution(p.id, "Fetching…");
      setExtras(p.id, "");
      setRaw(p.id, "{}");

      try {
        const r = await fetch(url, { cache: "no-store" });
        const text = await r.text();

        if (!r.ok) {
          setStatus(p.id, `HTTP ${r.status}`);
          setSolution(p.id, `Request failed: HTTP ${r.status}`);
          setRaw(p.id, text);
          return;
        }

        let data;
        try {
          data = JSON.parse(text);
        } catch {
          setStatus(p.id, "Bad JSON");
          setSolution(p.id, "Could not parse JSON.");
          setRaw(p.id, text);
          return;
        }

        setRaw(p.id, data);

        const solutionText = p.extract(data);
        setSolution(p.id, solutionText);

        if (typeof p.renderExtras === "function") {
          setExtras(p.id, p.renderExtras(data, p.id));
        } else {
          setExtras(p.id, "");
        }

        setStatus(p.id, "OK");
      } catch (e) {
        setStatus(p.id, "Error");
        setSolution(p.id, `Error: ${e.message}`);
        setRaw(p.id, String(e));
      }
    }

    // ---- Utils ----
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[c]));
    }

    // ---- Init ----
    renderAccordion();

    const dateEl = document.getElementById("date");
    dateEl.value = todayISO();

    document.getElementById("refresh").addEventListener("click", () => {
      loadAll(dateEl.value);
    });

    document.getElementById("quickToday").addEventListener("click", () => {
      dateEl.value = addDaysISO(0);
      loadAll(dateEl.value);
    });

    document.getElementById("quickYesterday").addEventListener("click", () => {
      dateEl.value = addDaysISO(-1);
      loadAll(dateEl.value);
    });

    document.getElementById("quickTomorrow").addEventListener("click", () => {
      dateEl.value = addDaysISO(1);
      loadAll(dateEl.value);
    });

    // Auto-load on first view
    loadAll(dateEl.value);
  </script>
</body>
</html>
